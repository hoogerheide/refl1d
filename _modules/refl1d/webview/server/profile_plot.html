<!DOCTYPE html>

<html lang="en" data-content_root="../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>refl1d.webview.server.profile_plot &#8212; Refl1D 0.7.7.post1533+gc6a0ac1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/haiku-site.css?v=ccbba224" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/plot_directive.css" />
    <script src="../../../../_static/documentation_options.js?v=132fb2fb"></script>
    <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../../../../index.html">
          <span>Refl1D 0.7.7.post1533+gc6a0ac1 documentation</span></a></h1>
        <h2 class="heading"><span>refl1d.webview.server.profile_plot</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="Top">
      
        <p>
        <a class="uplink" href="../../../../index.html">Contents</a>
        </p>

      </div>
      <div class="content" role="main">
        
        
  <h1>Source code for refl1d.webview.server.profile_plot</h1><div class="highlight"><pre>
<span></span><span class="c1"># Below taken from the GUI profile plot methods in Refl1d - modified to be stand alone</span>
<span class="c1"># This is to allow for the layer labels to be easily added to the SLD plots</span>

<span class="c1"># Originally written for use in a jupyter notebook</span>
<span class="c1"># Adapted to act as a prototype for the profile plotting in the new GUI for refl1d</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">TypedDict</span><span class="p">,</span> <span class="n">TYPE_CHECKING</span>
<span class="kn">from</span> <span class="nn">refl1d.experiment</span> <span class="kn">import</span> <span class="n">Experiment</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">inf</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">plotly.graph_objs</span> <span class="k">as</span> <span class="nn">go</span>

<span class="kn">from</span> <span class="nn">.colors</span> <span class="kn">import</span> <span class="n">COLORS</span> <span class="k">as</span> <span class="n">MULTI_PLOT_COLORS</span>

<span class="n">SINGLE_PLOT_COLORS</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;gold&quot;</span><span class="p">)</span>

<span class="n">SINGLE_PLOT_STYLES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;solid&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span>
<span class="n">MULTI_PLOT_STYLES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;solid&quot;</span><span class="p">,</span> <span class="s2">&quot;dash&quot;</span><span class="p">,</span> <span class="s2">&quot;dashdot&quot;</span><span class="p">,</span> <span class="s2">&quot;dot&quot;</span><span class="p">]</span>

<span class="c1"># === Sample information ===</span>


<div class="viewcode-block" id="FindLayers">
<a class="viewcode-back" href="../../../../refl1d.webview.server.profile_plot.html#refl1d.webview.server.profile_plot.FindLayers">[docs]</a>
<span class="k">class</span> <span class="nc">FindLayers</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiment</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">x_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span> <span class="o">=</span> <span class="n">experiment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_offset</span> <span class="o">=</span> <span class="n">x_offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_show_labels</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_show_boundaries</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_find_layer_boundaries</span><span class="p">()</span>

<div class="viewcode-block" id="FindLayers.find">
<a class="viewcode-back" href="../../../../refl1d.webview.server.profile_plot.html#refl1d.webview.server.profile_plot.FindLayers.find">[docs]</a>
    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_offset</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_find_layer_boundaries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_offset</span>
        <span class="n">boundary</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">inf</span><span class="p">,</span> <span class="n">offset</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="p">,</span> <span class="s2">&quot;sample&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">L</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">sample</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">dx</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">thickness</span><span class="o">.</span><span class="n">value</span>
                <span class="n">offset</span> <span class="o">+=</span> <span class="n">dx</span>
                <span class="n">boundary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
        <span class="n">boundary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boundary</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">boundary</span><span class="p">)</span>

<div class="viewcode-block" id="FindLayers.sample_labels">
<a class="viewcode-back" href="../../../../refl1d.webview.server.profile_plot.html#refl1d.webview.server.profile_plot.FindLayers.sample_labels">[docs]</a>
    <span class="k">def</span> <span class="nf">sample_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">L</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">L</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">sample</span><span class="p">]</span></div>


<div class="viewcode-block" id="FindLayers.sample_layer">
<a class="viewcode-back" href="../../../../refl1d.webview.server.profile_plot.html#refl1d.webview.server.profile_plot.FindLayers.sample_layer">[docs]</a>
    <span class="k">def</span> <span class="nf">sample_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">sample</span><span class="p">[</span><span class="n">n</span><span class="p">]</span></div>


<div class="viewcode-block" id="FindLayers.label_offsets">
<a class="viewcode-back" href="../../../../refl1d.webview.server.profile_plot.html#refl1d.webview.server.profile_plot.FindLayers.label_offsets">[docs]</a>
    <span class="k">def</span> <span class="nf">label_offsets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">left</span> <span class="o">=</span> <span class="o">-</span><span class="mi">20</span>
        <span class="n">middle</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">z</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">:])]</span>
        <span class="n">right</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">20</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">left</span><span class="p">]</span> <span class="o">+</span> <span class="n">middle</span> <span class="o">+</span> <span class="p">[</span><span class="n">right</span><span class="p">]</span></div>


<div class="viewcode-block" id="FindLayers.reset_markers_plotly">
<a class="viewcode-back" href="../../../../refl1d.webview.server.profile_plot.html#refl1d.webview.server.profile_plot.FindLayers.reset_markers_plotly">[docs]</a>
    <span class="k">def</span> <span class="nf">reset_markers_plotly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reset all markers, for plotly plots</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">plotly.graph_objs</span> <span class="k">as</span> <span class="nn">go</span>

        <span class="c1"># self.clear_markers()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;reset_markers_plotly can only be used with type: axes=plotly.graph_objs.Figure&quot;</span><span class="p">)</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span>

        <span class="c1"># Add bars</span>
        <span class="n">fittable</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">sample</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">thickness</span><span class="o">.</span><span class="n">fittable</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>
        <span class="n">fittable</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># First interface is not fittable</span>

        <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">z_pos</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fittable</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">line_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">dash</span><span class="o">=</span><span class="s2">&quot;dash&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">dash</span><span class="o">=</span><span class="s2">&quot;solid&quot;</span><span class="p">)</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">add_vline</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">z_pos</span><span class="p">,</span>
                <span class="n">opacity</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span>
                <span class="n">line</span><span class="o">=</span><span class="n">line_dict</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># for f,m in zip(fittable,self.markers):</span>
        <span class="c1">#     if not f: m.set(linestyle=&#39;--&#39;, linewidth=1.25)</span>
        <span class="c1"># self.connect_markers(m for f,m in zip(fittable,self.markers) if f)</span>

        <span class="c1"># Add labels</span>
        <span class="n">offsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_offsets</span><span class="p">()</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_labels</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">label_pos</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">offsets</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_annotation</span><span class="p">(</span>
                <span class="n">text</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">textangle</span><span class="o">=-</span><span class="mi">30</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">label_pos</span><span class="p">,</span> <span class="n">yref</span><span class="o">=</span><span class="s2">&quot;paper&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">yanchor</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="n">showarrow</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="generate_best_profile">
<a class="viewcode-back" href="../../../../refl1d.webview.server.profile_plot.html#refl1d.webview.server.profile_plot.generate_best_profile">[docs]</a>
<span class="k">def</span> <span class="nf">generate_best_profile</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">Experiment</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">ismagnetic</span><span class="p">:</span>
        <span class="n">best</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">magnetic_smooth_profile</span><span class="p">(</span><span class="n">dz</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">best</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">smooth_profile</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">best</span></div>



<span class="c1"># ============================================================================= #</span>
<span class="c1"># Plotting script below</span>
<span class="c1"># ============================================================================= #</span>


<div class="viewcode-block" id="ModelSpec">
<a class="viewcode-back" href="../../../../refl1d.webview.server.profile_plot.html#refl1d.webview.server.profile_plot.ModelSpec">[docs]</a>
<span class="k">class</span> <span class="nc">ModelSpec</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">model_index</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">sample_index</span><span class="p">:</span> <span class="nb">int</span></div>



<div class="viewcode-block" id="PlotItem">
<a class="viewcode-back" href="../../../../refl1d.webview.server.profile_plot.html#refl1d.webview.server.profile_plot.PlotItem">[docs]</a>
<span class="k">class</span> <span class="nc">PlotItem</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Experiment</span>
    <span class="n">spec</span><span class="p">:</span> <span class="n">ModelSpec</span>
    <span class="n">color_index</span><span class="p">:</span> <span class="nb">int</span></div>



<div class="viewcode-block" id="plot_multiple_sld_profiles">
<a class="viewcode-back" href="../../../../refl1d.webview.server.profile_plot.html#refl1d.webview.server.profile_plot.plot_multiple_sld_profiles">[docs]</a>
<span class="k">def</span> <span class="nf">plot_multiple_sld_profiles</span><span class="p">(</span><span class="n">plot_items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PlotItem</span><span class="p">]):</span>
    <span class="kn">import</span> <span class="nn">plotly.graph_objs</span> <span class="k">as</span> <span class="nn">go</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
    <span class="n">nplots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_items</span><span class="p">)</span>
    <span class="n">multiplot</span> <span class="o">=</span> <span class="n">nplots</span> <span class="o">&gt;</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">plot_item</span> <span class="ow">in</span> <span class="n">plot_items</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">plot_item</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">plot_item</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">]</span>
        <span class="n">color_index</span> <span class="o">=</span> <span class="n">plot_item</span><span class="p">[</span><span class="s2">&quot;color_index&quot;</span><span class="p">]</span>
        <span class="n">model_index</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;model_index&quot;</span><span class="p">]</span>
        <span class="n">sample_index</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;sample_index&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">multiplot</span><span class="p">:</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">MULTI_PLOT_COLORS</span><span class="p">[</span><span class="n">color_index</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">MULTI_PLOT_COLORS</span><span class="p">)]]</span> <span class="o">*</span> <span class="mi">4</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">SINGLE_PLOT_COLORS</span>
        <span class="n">line_styles</span> <span class="o">=</span> <span class="n">MULTI_PLOT_STYLES</span> <span class="k">if</span> <span class="n">multiplot</span> <span class="k">else</span> <span class="n">SINGLE_PLOT_STYLES</span>
        <span class="n">legendgroup</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_index</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">sample_index</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="k">if</span> <span class="n">multiplot</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">plot_sld_profile_plotly</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">line_styles</span><span class="o">=</span><span class="n">line_styles</span><span class="p">,</span> <span class="n">legendgroup</span><span class="o">=</span><span class="n">legendgroup</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span></div>



<div class="viewcode-block" id="plot_sld_profile_plotly">
<a class="viewcode-back" href="../../../../refl1d.webview.server.profile_plot.html#refl1d.webview.server.profile_plot.plot_sld_profile_plotly">[docs]</a>
<span class="k">def</span> <span class="nf">plot_sld_profile_plotly</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">SINGLE_PLOT_COLORS</span><span class="p">,</span> <span class="n">line_styles</span><span class="o">=</span><span class="n">SINGLE_PLOT_STYLES</span><span class="p">,</span> <span class="n">legendgroup</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">ismagnetic</span><span class="p">:</span>
        <span class="n">z_best</span><span class="p">,</span> <span class="n">rho_best</span><span class="p">,</span> <span class="n">irho_best</span><span class="p">,</span> <span class="n">rhoM_best</span><span class="p">,</span> <span class="n">thetaM_best</span> <span class="o">=</span> <span class="n">generate_best_profile</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">yaxis_title</span> <span class="o">=</span> <span class="s2">&quot;SLD: ρ, ρ&lt;sub&gt;i&lt;/sub&gt;, ρ&lt;sub&gt;M&lt;/sub&gt; / 10&lt;sup&gt;-6&lt;/sup&gt; Å&lt;sup&gt;-2&lt;/sup&gt;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">z_best</span><span class="p">,</span> <span class="n">rho_best</span><span class="p">,</span> <span class="n">irho_best</span> <span class="o">=</span> <span class="n">generate_best_profile</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">yaxis_title</span> <span class="o">=</span> <span class="s2">&quot;SLD: ρ, ρ&lt;sub&gt;i&lt;/sub&gt; / 10&lt;sup&gt;-6&lt;/sup&gt; Å&lt;sup&gt;-2&lt;/sup&gt;&quot;</span>

    <span class="n">hovertemplate</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;(%</span><span class="se">{{</span><span class="s2">x</span><span class="se">}}</span><span class="s2">, %</span><span class="se">{{</span><span class="s2">y</span><span class="se">}}</span><span class="s2">)&lt;br&gt;</span><span class="si">{</span><span class="n">legendgroup</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">legendgroup</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2"> %</span><span class="se">{{</span><span class="s2">data.hovertext</span><span class="se">}}</span><span class="s2">&lt;extra&gt;&lt;/extra&gt;&quot;</span>
    <span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">add_scatter</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">z_best</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">rho_best</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ρ&quot;</span><span class="p">,</span>
        <span class="n">legendgroup</span><span class="o">=</span><span class="n">legendgroup</span><span class="p">,</span>
        <span class="n">legendgrouptitle_text</span><span class="o">=</span><span class="n">legendgroup</span><span class="p">,</span>
        <span class="n">hovertemplate</span><span class="o">=</span><span class="n">hovertemplate</span><span class="p">,</span>
        <span class="n">hovertext</span><span class="o">=</span><span class="s2">&quot;SLD&quot;</span><span class="p">,</span>
        <span class="n">line</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;dash&quot;</span><span class="p">:</span> <span class="n">line_styles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">add_scatter</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">z_best</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">irho_best</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ρ&lt;sub&gt;i&lt;/sub&gt;&quot;</span><span class="p">,</span>
        <span class="n">legendgroup</span><span class="o">=</span><span class="n">legendgroup</span><span class="p">,</span>
        <span class="n">hovertemplate</span><span class="o">=</span><span class="n">hovertemplate</span><span class="p">,</span>
        <span class="n">hovertext</span><span class="o">=</span><span class="s2">&quot;Im. SLD&quot;</span><span class="p">,</span>
        <span class="n">line</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">colors</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;dash&quot;</span><span class="p">:</span> <span class="n">line_styles</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">ismagnetic</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_scatter</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">z_best</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">rhoM_best</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ρ&lt;sub&gt;M&lt;/sub&gt;&quot;</span><span class="p">,</span>
            <span class="n">legendgroup</span><span class="o">=</span><span class="n">legendgroup</span><span class="p">,</span>
            <span class="n">hovertemplate</span><span class="o">=</span><span class="n">hovertemplate</span><span class="p">,</span>
            <span class="n">hovertext</span><span class="o">=</span><span class="s2">&quot;Mag. SLD&quot;</span><span class="p">,</span>
            <span class="n">line</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">colors</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="s2">&quot;dash&quot;</span><span class="p">:</span> <span class="n">line_styles</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">add_scatter</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">z_best</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">thetaM_best</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;θ&lt;sub&gt;M&lt;/sub&gt;&quot;</span><span class="p">,</span>
            <span class="n">yaxis</span><span class="o">=</span><span class="s2">&quot;y2&quot;</span><span class="p">,</span>
            <span class="n">legendgroup</span><span class="o">=</span><span class="n">legendgroup</span><span class="p">,</span>
            <span class="n">hovertemplate</span><span class="o">=</span><span class="n">hovertemplate</span><span class="p">,</span>
            <span class="n">hovertext</span><span class="o">=</span><span class="s2">&quot;Theta M&quot;</span><span class="p">,</span>
            <span class="n">line</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">colors</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                <span class="s2">&quot;dash&quot;</span><span class="p">:</span> <span class="n">line_styles</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># TODO: need to make axis scaling for thetaM dependent on if thetaM exceeds 0-360</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">yaxis2</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Magnetic Angle θ&lt;sub&gt;M&lt;/sub&gt; / °&quot;</span><span class="p">},</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;linear&quot;</span><span class="p">,</span>
                <span class="s2">&quot;autorange&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;range&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">],</span>
                <span class="s2">&quot;anchor&quot;</span><span class="p">:</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span>
                <span class="s2">&quot;overlaying&quot;</span><span class="p">:</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span>
                <span class="s2">&quot;side&quot;</span><span class="p">:</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ticks&quot;</span><span class="p">:</span> <span class="s2">&quot;inside&quot;</span><span class="p">,</span>
                <span class="c1"># &#39;ticklen&#39;: 20,</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">uirevision</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">plot_bgcolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">xaxis</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;depth (Å)&quot;</span><span class="p">},</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;linear&quot;</span><span class="p">,</span>
            <span class="s2">&quot;autorange&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="c1"># &#39;gridcolor&#39;: &quot;Grey&quot;,</span>
            <span class="s2">&quot;ticks&quot;</span><span class="p">:</span> <span class="s2">&quot;inside&quot;</span><span class="p">,</span>
            <span class="c1"># &#39;ticklen&#39;: 20,</span>
            <span class="s2">&quot;showline&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;linecolor&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mirror&quot;</span><span class="p">:</span> <span class="s2">&quot;ticks&quot;</span><span class="p">,</span>
            <span class="s2">&quot;side&quot;</span><span class="p">:</span> <span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">yaxis</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">yaxis_title</span><span class="p">},</span>
            <span class="s2">&quot;exponentformat&quot;</span><span class="p">:</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span>
            <span class="s2">&quot;showexponent&quot;</span><span class="p">:</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;linear&quot;</span><span class="p">,</span>
            <span class="s2">&quot;autorange&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="c1"># &#39;gridcolor&#39;: &quot;Grey&quot;,</span>
            <span class="s2">&quot;ticks&quot;</span><span class="p">:</span> <span class="s2">&quot;inside&quot;</span><span class="p">,</span>
            <span class="c1"># &#39;ticklen&#39;: 20,</span>
            <span class="s2">&quot;showline&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;linecolor&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mirror&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">margin</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;l&quot;</span><span class="p">:</span> <span class="mi">75</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">75</span><span class="p">,</span> <span class="s2">&quot;pad&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">})</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">legend</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="s2">&quot;bgcolor&quot;</span><span class="p">:</span> <span class="s2">&quot;rgba(255,215,0,0.15)&quot;</span><span class="p">,</span>
            <span class="c1"># &quot;traceorder&quot;: &quot;reversed&quot;</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="n">marker_positions</span> <span class="o">=</span> <span class="n">FindLayers</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">fig</span><span class="p">)</span>
    <span class="n">marker_positions</span><span class="o">.</span><span class="n">reset_markers_plotly</span><span class="p">()</span>

    <span class="c1"># fig.show(renderer=&#39;firefox&#39;)</span>
    <span class="k">return</span> <span class="n">fig</span></div>



<span class="c1"># def plot_contours(model, title, savepath=None, nsamples=1000, show_contours=True, show_mag=True, savetitle=None,</span>
<span class="c1">#                   store=None, ultranest=False, dream=False, align=0):</span>
<span class="c1">#     if show_contours:</span>
<span class="c1">#         # data, columns = generate_contour_data(model)</span>
<span class="c1">#         if ultranest:</span>
<span class="c1">#             points_array = model.post_samples</span>
<span class="c1">#             sub_array = points_array[np.sort(np.random.randint(points_array.shape[0], size=nsamples)), :]</span>
<span class="c1">#             errors = calc_errors(model.problem, sub_array)</span>
<span class="c1">#             data, columns = generate_profile_data(errors)</span>
<span class="c1">#         # if this comment is removed the above code will not overwrite the previous reference to the errors object</span>
<span class="c1">#         # and it will act as a bad memory leak - using more ram everytime the function is called</span>
<span class="c1">#         if dream:</span>
<span class="c1">#             state, points = load_dream_state_notebook(problem=model.problem, store=store)</span>
<span class="c1">#             errors = calc_errors(model.problem, points[-nsamples:-1])</span>
<span class="c1">#             data, columns = generate_profile_data(errors, align)</span>
<span class="c1">#</span>
<span class="c1">#     # get best profile manually as we are not using DREAM state</span>
<span class="c1">#     if show_mag:</span>
<span class="c1">#         z_best, rho_best, irho_best, rhoM_best, thetaM_best = generate_best_profile(model)</span>
<span class="c1">#     else:</span>
<span class="c1">#         z_best, rho_best, irho_best = generate_best_profile(model)</span>
<span class="c1">#</span>
<span class="c1">#     fig, ax = plt.subplots(1, 1, figsize=(8, 6))</span>
<span class="c1">#</span>
<span class="c1">#     # rho</span>
<span class="c1">#     if show_contours:</span>
<span class="c1">#         z, best, sig2lo, sig2hi, siglo, sighi = data[0]</span>
<span class="c1">#         ax.plot(z, best, label=r&quot;$\rho$ SLD&quot;, color=&quot;orange&quot;)</span>
<span class="c1">#         ax.fill_between(z, siglo, sighi, alpha=0.5, color=&quot;orange&quot;, label=r&quot;$\rho$ SLD $1\sigma$&quot;)</span>
<span class="c1">#         ax.fill_between(z, sig2lo, sig2hi, alpha=0.25, color=&quot;orange&quot;, label=r&quot;$\rho$ SLD $2\sigma$&quot;)</span>
<span class="c1">#     else:</span>
<span class="c1">#         ax.plot(z_best, rho_best, label=r&quot;$\rho$ SLD&quot;, color=&quot;orange&quot;)</span>
<span class="c1">#</span>
<span class="c1">#     # irho</span>
<span class="c1">#     # ax.plot(z_best, irho_best, label=r&quot;$\rho_{i}$ Im SLD&quot;)</span>
<span class="c1">#     # if show_contours:</span>
<span class="c1">#     #     z, best, sig2lo, sig2hi, siglo, sighi = data[1]</span>
<span class="c1">#     #     ax.fill_between(z, siglo, sighi, alpha=0.5)</span>
<span class="c1">#     #     ax.fill_between(z, sig2lo, sig2hi, alpha=0.25)</span>
<span class="c1">#     if show_mag:</span>
<span class="c1">#         if show_contours:</span>
<span class="c1">#             z, best, sig2lo, sig2hi, siglo, sighi = data[2]</span>
<span class="c1">#             ax.plot(z, best, label=r&quot;$\rho_{M}$ mSLD&quot;, color=&quot;b&quot;)</span>
<span class="c1">#             ax.fill_between(z, siglo, sighi, alpha=0.5, color=&quot;b&quot;, label=r&quot;$\rho_{M}$ mSLD $1\sigma$&quot;)</span>
<span class="c1">#             ax.fill_between(z, sig2lo, sig2hi, alpha=0.25, color=&quot;b&quot;, label=r&quot;$\rho_{M}$ mSLD $2\sigma$&quot;)</span>
<span class="c1">#         else:</span>
<span class="c1">#             ax.plot(z_best, rhoM_best, label=r&quot;$\rho_{M}$ mSLD&quot;, color=&quot;b&quot;)</span>
<span class="c1">#</span>
<span class="c1">#     # ax.legend(fontsize=14, loc=&#39;upper right&#39;, framealpha=0.5, ncol=2)</span>
<span class="c1">#     ax.legend(fontsize=16, framealpha=0.5, ncol=3)</span>
<span class="c1">#</span>
<span class="c1">#     ax.grid(True)</span>
<span class="c1">#     ax.set_xlabel(r&quot;z $\left(\AA\right)$&quot;, fontsize=18)</span>
<span class="c1">#     ax.set_ylabel(r&quot;$\rho, \rho_{i} \left(10^{-6}\AA^{-2}\right)$&quot;, fontsize=18)</span>
<span class="c1">#     if show_mag:</span>
<span class="c1">#         ax.set_ylabel(r&quot;$\rho, \rho_{M} \left(10^{-6}\AA^{-2}\right)$&quot;, fontsize=18)</span>
<span class="c1">#     ax.tick_params(axis=&#39;y&#39;, labelsize=16)</span>
<span class="c1">#     ax.tick_params(axis=&#39;x&#39;, labelsize=16)</span>
<span class="c1">#</span>
<span class="c1">#     experiment = model.determine_problem_fitness()</span>
<span class="c1">#</span>
<span class="c1">#     layer_markers = FindLayers(experiment, axes=ax)</span>
<span class="c1">#     layer_markers.reset_markers()</span>
<span class="c1">#     fig.suptitle(title)</span>
<span class="c1">#     # if np.max(rho_best) &gt; 75:</span>
<span class="c1">#     #     top = np.max(rho_best)*1.15</span>
<span class="c1">#     # else:</span>
<span class="c1">#     #     top =75</span>
<span class="c1">#     # ax.set_ylim(top=top)</span>
<span class="c1">#     if savepath:</span>
<span class="c1">#         if savetitle:</span>
<span class="c1">#             title = savetitle</span>
<span class="c1">#         plt.savefig(f&quot;{savepath}/{title}.png&quot;)</span>
</pre></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="Bottom">
      
        <p>
        <a class="uplink" href="../../../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    </div>
  </body>
</html>